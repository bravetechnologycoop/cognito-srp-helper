var re=Object.create;var T=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var ae=(t,e)=>{for(var r in e)T(t,r,{get:e[r],enumerable:!0})},X=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of se(e))!ie.call(t,s)&&s!==r&&T(t,s,{get:()=>e[s],enumerable:!(n=ne(e,s))||n.enumerable});return t};var ce=(t,e,r)=>(r=t!=null?re(oe(t)):{},X(e||!t||!t.__esModule?T(r,"default",{value:t,enumerable:!0}):r,t)),ge=t=>X(T({},"__esModule",{value:!0}),t);var we={};ae(we,{AbortOnZeroASrpError:()=>H,AbortOnZeroBSrpError:()=>E,AbortOnZeroSrpError:()=>w,AbortOnZeroUSrpError:()=>v,MissingChallengeResponsesError:()=>B,MissingDeviceKeyError:()=>P,MissingLargeBError:()=>C,MissingSaltError:()=>A,MissingSecretError:()=>S,MissingUserIdForSrpBError:()=>D,SignSrpSessionError:()=>d,createDeviceVerifier:()=>pe,createPasswordHash:()=>J,createSecretHash:()=>he,createSrpSession:()=>me,signSrpSession:()=>Be,signSrpSessionWithDevice:()=>Ae,wrapAuthChallenge:()=>Ce,wrapInitiateAuth:()=>Se});module.exports=ge(we);var i=require("buffer/"),g=ce(require("crypto-js"),1);function le(t){return BigInt(`0x${t}`)}var o=class t{value;static ZERO=new t(0);static ONE=new t(1);constructor(e,r=10){if(typeof e=="string")this.value=r===16?le(e):BigInt(e);else if(typeof e=="number")this.value=BigInt(e);else if(e instanceof t)this.value=e.value;else throw new Error("Unsupported BigInteger input type")}toString(e=10){return this.value.toString(e)}modPow(e,r){let n=this.value,s=e.value,a=r.value,c=BigInt(1);for(n=n%a;s>BigInt(0);)s%BigInt(2)===BigInt(1)&&(c=c*n%a),n=n*n%a,s=s>>BigInt(1);return new t(c.toString(16),16)}multiply(e){return new t((this.value*e.value).toString(16),16)}mod(e){return new t((this.value%e.value).toString(16),16)}add(e){return new t((this.value+e.value).toString(16),16)}subtract(e){return new t((this.value-e.value).toString(16),16)}compareTo(e){return this.value<e.value?-1:this.value>e.value?1:0}equals(e){return this.value===e.value}isZero(){return this.value===BigInt(0)}abs(){return this.value<BigInt(0)?new t((-this.value).toString(16),16):this}};var M=require("buffer/");var _=require("buffer/"),I=require("crypto-js");var O=t=>{let e=t instanceof _.Buffer?I.lib.WordArray.create(t):t,r=(0,I.SHA256)(e).toString();return new Array(64-r.length).join("0")+r},p=t=>O(_.Buffer.from(t,"hex")),u=t=>{if(!(t instanceof o))throw new Error("Not a BigInteger");let e=t.compareTo(o.ZERO)<0,r=t.abs().toString(16);if(r=r.length%2!==0?`0${r}`:r,r=/^[89a-f]/i.test(r)?`00${r}`:r,e){let s=r.split("").map(c=>{let l=~parseInt(c,16)&15;return"0123456789ABCDEF".charAt(l)}).join("");r=new o(s,16).add(o.ONE).toString(16),r.toUpperCase().startsWith("FF8")&&(r=r.substring(2))}return r},L=t=>_.Buffer.from(I.lib.WordArray.random(t).toString(),"hex"),N=t=>{if(t.length%2!==0)throw new Error("Hex encoded strings must have an even number length");let e=new Uint8Array(t.length/2);for(let r=0;r<t.length;r+=2){let n=t.slice(r,r+2).toLowerCase();if(n in K)e[r/2]=K[n];else throw new Error(`Cannot decode unrecognized sequence ${n} as hexadecimal`)}return e};var q=M.Buffer.from("Caldera Derived Key","utf8"),R=new o("2",16),m=new o("FFFFFFFFFFFFFFFFC90FDAA22168C234C4C6628B80DC1CD129024E088A67CC74020BBEA63B139B22514A08798E3404DDEF9519B3CD3A431B302B0A6DF25F14374FE1356D6D51C245E485B576625E7EC6F44C42E9A637ED6B0BFF5CB6F406B7EDEE386BFB5A899FA5AE9F24117C4B1FE649286651ECE45B3DC2007CB8A163BF0598DA48361C55D39A69163FA8FD24CF5F83655D23DCA3AD961C62F356208552BB9ED529077096966D670C354E4ABC9804F1746C08CA18217C32905E462E36CE3BE39E772C180E86039B2783A2EC07A28FB5C55DF06F4C52C9DE2BCBF6955817183995497CEA956AE515D2261898FA051015728E5A8AAAC42DAD33170D04507A33A85521ABDF1CBA64ECFB850458DBEF0A8AEA71575D060C7DB3970F85A6E1E4C7ABF5AE8CDB0933D71E8C94E04A25619DCEE3D2261AD2EE6BF12FFA06D98A0864D87602733EC86A64521F2B18177B200CBBE117577A615D6C770988C0BAD946E208E24FA074E5AB3143DB5BFCE0FD108E4B82D120A93AD2CAFFFFFFFFFFFFFFFF",16),Z=new o(p(`${u(m)}${u(R)}`),16),K={"00":0,"01":1,"02":2,"03":3,"04":4,"05":5,"06":6,"07":7,"08":8,"09":9,"0a":10,"0b":11,"0c":12,"0d":13,"0e":14,"0f":15,10:16,11:17,12:18,13:19,14:20,15:21,16:22,17:23,18:24,19:25,"1a":26,"1b":27,"1c":28,"1d":29,"1e":30,"1f":31,20:32,21:33,22:34,23:35,24:36,25:37,26:38,27:39,28:40,29:41,"2a":42,"2b":43,"2c":44,"2d":45,"2e":46,"2f":47,30:48,31:49,32:50,33:51,34:52,35:53,36:54,37:55,38:56,39:57,"3a":58,"3b":59,"3c":60,"3d":61,"3e":62,"3f":63,40:64,41:65,42:66,43:67,44:68,45:69,46:70,47:71,48:72,49:73,"4a":74,"4b":75,"4c":76,"4d":77,"4e":78,"4f":79,50:80,51:81,52:82,53:83,54:84,55:85,56:86,57:87,58:88,59:89,"5a":90,"5b":91,"5c":92,"5d":93,"5e":94,"5f":95,60:96,61:97,62:98,63:99,64:100,65:101,66:102,67:103,68:104,69:105,"6a":106,"6b":107,"6c":108,"6d":109,"6e":110,"6f":111,70:112,71:113,72:114,73:115,74:116,75:117,76:118,77:119,78:120,79:121,"7a":122,"7b":123,"7c":124,"7d":125,"7e":126,"7f":127,80:128,81:129,82:130,83:131,84:132,85:133,86:134,87:135,88:136,89:137,"8a":138,"8b":139,"8c":140,"8d":141,"8e":142,"8f":143,90:144,91:145,92:146,93:147,94:148,95:149,96:150,97:151,98:152,99:153,"9a":154,"9b":155,"9c":156,"9d":157,"9e":158,"9f":159,a0:160,a1:161,a2:162,a3:163,a4:164,a5:165,a6:166,a7:167,a8:168,a9:169,aa:170,ab:171,ac:172,ad:173,ae:174,af:175,b0:176,b1:177,b2:178,b3:179,b4:180,b5:181,b6:182,b7:183,b8:184,b9:185,ba:186,bb:187,bc:188,bd:189,be:190,bf:191,c0:192,c1:193,c2:194,c3:195,c4:196,c5:197,c6:198,c7:199,c8:200,c9:201,ca:202,cb:203,cc:204,cd:205,ce:206,cf:207,d0:208,d1:209,d2:210,d3:211,d4:212,d5:213,d6:214,d7:215,d8:216,d9:217,da:218,db:219,dc:220,dd:221,de:222,df:223,e0:224,e1:225,e2:226,e3:227,e4:228,e5:229,e6:230,e7:231,e8:232,e9:233,ea:234,eb:235,ec:236,ed:237,ee:238,ef:239,f0:240,f1:241,f2:242,f3:243,f4:244,f5:245,f6:246,f7:247,f8:248,f9:249,fa:250,fb:251,fc:252,fd:253,fe:254,ff:255};var d=class extends Error{constructor(e="Could not sign SRP session"){super(e)}},B=class extends d{constructor(e="Could not sign SRP session because of missing or undefined ChallengeResponses in response"){super(e)}},A=class extends d{constructor(e="Could not sign SRP session because of missing or undefined SALT in response.ChallengeResponses"){super(e)}},S=class extends d{constructor(e="Could not sign SRP session because of missing or undefined SECRET_BLOCK in response.ChallengeResponses"){super(e)}},C=class extends d{constructor(e="Could not sign SRP session because of missing or undefined SRP_B in response.ChallengeResponses"){super(e)}},D=class extends d{constructor(e="Could not sign SRP session because of missing or undefined USER_ID_FOR_SRP in response.ChallengeResponses"){super(e)}},P=class extends d{constructor(e="Could not sign SRP session because of missing or undefined DEVICE_KEY in response.ChallengeResponses"){super(e)}},w=class extends Error{constructor(e="Aborting SRP due to 0 value"){super(e)}},H=class extends w{constructor(e="Aborting SRP due to 0 value received for client public key (A)"){super(e)}},E=class extends w{constructor(e="Aborting SRP due to 0 value received for server public key (B)"){super(e)}},v=class extends w{constructor(e="Aborting SRP due to 0 value received for public key hash (u)"){super(e)}};var ue=()=>{let t=L(128).toString("hex");return new o(t,16)},de=t=>{let e=R.modPow(t,m);if(e.equals(o.ZERO))throw new H;return e},G=(t,e)=>{let r=g.default.lib.WordArray.create(i.Buffer.concat([q,i.Buffer.from(String.fromCharCode(1),"utf8")])),n=t instanceof i.Buffer?g.default.lib.WordArray.create(t):t,s=e instanceof i.Buffer?g.default.lib.WordArray.create(e):e,a=g.default.HmacSHA256(n,s),c=g.default.HmacSHA256(r,a);return i.Buffer.from(c.toString(),"hex").slice(0,16)},Y=(t,e)=>{let r=p(u(t)+u(e)),n=new o(r,16);if(n.equals(o.ZERO))throw new v;return n},j=(t,e,r,n)=>{let s=R.modPow(t,m);return e.subtract(Z.multiply(s)).modPow(r.add(n.multiply(t)),m)},z=(t,e)=>new o(p(u(t)+e),16),fe=()=>{let t=new Date,e="en-US",r="UTC",n=t.toLocaleString(e,{timeZone:r,weekday:"short"}),s=t.toLocaleString(e,{day:"numeric",timeZone:r}),a=t.toLocaleString(e,{month:"short",timeZone:r}),c=t.getUTCFullYear(),l=t.toLocaleString(e,{hour:"2-digit",hourCycle:"h23",minute:"2-digit",second:"2-digit",timeZone:r});return`${n} ${a} ${s} ${l} UTC ${c}`},he=(t,e,r)=>g.default.HmacSHA256(`${t}${e}`,r).toString(g.default.enc.Base64),J=(t,e,r)=>{let s=`${r.split("_")[1]}${t}:${e}`;return O(s)},Q=(t,e,r)=>{let n=`${r}${t}:${e}`;return O(n)},pe=(t,e)=>{let r=L(40).toString("base64"),n=Q(t,r,e),s=L(16).toString("hex"),a=u(new o(s,16)),c=N(a),l=i.Buffer.from(c).toString("base64"),f=p(a+n),b=R.modPow(new o(f,16),m),F=u(b),x=N(F),h=i.Buffer.from(x).toString("base64");return{DeviceRandomPassword:r,DeviceSecretVerifierConfig:{PasswordVerifier:h,Salt:l}}},me=(t,e,r,n=!0)=>{let s=r.split("_")[1],a=fe(),c=ue(),l=de(c);return{username:t,poolId:r,poolIdAbbr:s,password:e,isHashed:n,timestamp:a,smallA:c.toString(16),largeA:l.toString(16)}},Be=(t,e)=>{if(!e.ChallengeParameters)throw new B;if(!e.ChallengeParameters.SALT)throw new A;if(!e.ChallengeParameters.SECRET_BLOCK)throw new S;if(!e.ChallengeParameters.SRP_B)throw new C;if(!e.ChallengeParameters.USER_ID_FOR_SRP)throw new D;let{SALT:r,SECRET_BLOCK:n,SRP_B:s,USER_ID_FOR_SRP:a}=e.ChallengeParameters,{poolId:c,poolIdAbbr:l,password:f,isHashed:b,timestamp:F,smallA:x,largeA:h}=t;if(s.replace(/^0+/,"")==="")throw new E;let $=b?f:J(a,f,c),y=Y(new o(h,16),new o(s,16)),W=z(new o(r,16),$),V=j(W,new o(s,16),new o(x,16),y),U=G(i.Buffer.from(u(V),"hex"),i.Buffer.from(u(y),"hex")),k=g.default.lib.WordArray.create(U),ee=g.default.lib.WordArray.create(i.Buffer.concat([i.Buffer.from(l,"utf8"),i.Buffer.from(a,"utf8"),i.Buffer.from(n,"base64"),i.Buffer.from(F,"utf8")])),te=g.default.enc.Base64.stringify(g.default.HmacSHA256(ee,k));return{...t,salt:r,secret:n,largeB:s,passwordSignature:te}},Ae=(t,e,r,n)=>{if(!e.ChallengeParameters)throw new B;if(!e.ChallengeParameters.SALT)throw new A;if(!e.ChallengeParameters.SECRET_BLOCK)throw new S;if(!e.ChallengeParameters.SRP_B)throw new C;if(!e.ChallengeParameters.DEVICE_KEY)throw new P;let{DEVICE_KEY:s,SALT:a,SECRET_BLOCK:c,SRP_B:l}=e.ChallengeParameters,{timestamp:f,smallA:b,largeA:F}=t;if(l.replace(/^0+/,"")==="")throw new E;let x=Q(s,n,r),h=Y(new o(F,16),new o(l,16)),$=z(new o(a,16),x),y=j($,new o(l,16),new o(b,16),h),W=G(i.Buffer.from(u(y),"hex"),i.Buffer.from(u(h),"hex")),V=g.default.lib.WordArray.create(W),U=g.default.lib.WordArray.create(i.Buffer.concat([i.Buffer.from(r,"utf8"),i.Buffer.from(s,"utf8"),i.Buffer.from(c,"base64"),i.Buffer.from(f,"utf8")])),k=g.default.enc.Base64.stringify(g.default.HmacSHA256(U,V));return{...t,salt:a,secret:c,largeB:l,passwordSignature:k}},Se=(t,e)=>({...e,AuthParameters:{...e.AuthParameters,SRP_A:t.largeA}}),Ce=(t,e)=>({...e,ChallengeResponses:{...e.ChallengeResponses,PASSWORD_CLAIM_SECRET_BLOCK:t.secret,PASSWORD_CLAIM_SIGNATURE:t.passwordSignature,SRP_A:t.largeA,TIMESTAMP:t.timestamp}});
/*!
 * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * SPDX-License-Identifier: Apache-2.0
 */
